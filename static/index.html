<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caddy Manager</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f8f9fa; }
        .tab-content { padding: 20px; border: 1px solid #dee2e6; border-top: none; background: white; }
        textarea { width: 100%; height: 300px; font-family: monospace; }
        .status-box { margin-top: 20px; padding: 15px; border-radius: 5px; background-color: #e9ecef; white-space: pre-wrap; display: none; }
        .table-responsive { margin-top: 20px; }
        .action-btns button { margin-right: 5px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <h1 class="mb-4">Caddy Manager</h1>

    <div class="d-flex justify-content-between mb-3">
        <div>
            <button class="btn btn-primary" onclick="app.saveStructuredConfig()">Apply Configuration</button>
            <button class="btn btn-secondary" onclick="app.validateConfig()">Validate Configuration</button>
        </div>
        <div id="globalStatus" class="status-box" style="margin-top:0; padding: 8px 15px; display:inline-block; font-weight: bold;"></div>
    </div>

    <!-- Main Tabs -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" id="general-tab" data-bs-toggle="tab" href="#general" role="tab">General</a></li>
        <li class="nav-item"><a class="nav-link" id="reverse-proxy-tab" data-bs-toggle="tab" href="#reverse-proxy" role="tab">Reverse Proxy</a></li>
        <li class="nav-item"><a class="nav-link" id="layer4-tab" data-bs-toggle="tab" href="#layer4" role="tab">Layer 4</a></li>
        <li class="nav-item"><a class="nav-link" id="certs-tab" data-bs-toggle="tab" href="#certs" role="tab">Certificates</a></li>
        <li class="nav-item"><a class="nav-link" id="control-tab" data-bs-toggle="tab" href="#control" role="tab">Control & Raw</a></li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="mainTabsContent">

        <!-- General Tab -->
        <div class="tab-pane fade show active" id="general" role="tabpanel">
            <h3>General Settings</h3>
            <form id="generalForm">
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="genEnabled">
                    <label class="form-check-label" for="genEnabled">Enable Caddy Configuration</label>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="genEnableLayer4">
                    <label class="form-check-label" for="genEnableLayer4">Enable Layer 4 Configuration</label>
                </div>
                <div class="mb-3">
                    <label for="genHttpPort" class="form-label">HTTP Port</label>
                    <input type="text" class="form-control" id="genHttpPort" placeholder="80">
                </div>
                <div class="mb-3">
                    <label for="genHttpsPort" class="form-label">HTTPS Port</label>
                    <input type="text" class="form-control" id="genHttpsPort" placeholder="443">
                </div>
                <div class="mb-3">
                    <label for="genLogLevel" class="form-label">Log Level</label>
                    <select class="form-select" id="genLogLevel">
                        <option value="">Default (INFO)</option>
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO">INFO</option>
                        <option value="WARN">WARN</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                </div>
            </form>
        </div>

        <!-- Reverse Proxy Tab -->
        <div class="tab-pane fade" id="reverse-proxy" role="tabpanel">
            <!-- Sub Tabs for Reverse Proxy -->
            <ul class="nav nav-pills mb-3" id="rpTabs" role="tablist">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#rp-domains">Domains</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#rp-subdomains">Subdomains</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#rp-handlers">Handlers</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#rp-accesslists">Access Lists</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#rp-basicauth">Basic Auth</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#rp-headers">Headers</a></li>
            </ul>

            <div class="tab-content border-0 p-0">
                <!-- Domains -->
                <div class="tab-pane fade show active" id="rp-domains">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>Domains</h4>
                        <button class="btn btn-sm btn-success" onclick="app.ui.openModal('domainModal')">+ Add Domain</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="domainsTable">
                            <thead><tr><th>En</th><th>Domain</th><th>Port</th><th>Desc</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Subdomains -->
                <div class="tab-pane fade" id="rp-subdomains">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>Subdomains</h4>
                        <button class="btn btn-sm btn-success" onclick="app.ui.openModal('subdomainModal')">+ Add Subdomain</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="subdomainsTable">
                            <thead><tr><th>En</th><th>Subdomain</th><th>Parent Domain</th><th>Desc</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Handlers -->
                <div class="tab-pane fade" id="rp-handlers">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>Handlers</h4>
                        <button class="btn btn-sm btn-success" onclick="app.ui.openModal('handlerModal')">+ Add Handler</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="handlersTable">
                            <thead><tr><th>En</th><th>Domain/Sub</th><th>Path</th><th>Upstream</th><th>Desc</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Access Lists -->
                <div class="tab-pane fade" id="rp-accesslists">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>Access Lists</h4>
                        <button class="btn btn-sm btn-success" onclick="app.ui.openModal('accessListModal')">+ Add Access List</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="accessListsTable">
                            <thead><tr><th>Name</th><th>Client IPs</th><th>Invert</th><th>Desc</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Basic Auth -->
                <div class="tab-pane fade" id="rp-basicauth">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>Basic Auth</h4>
                        <button class="btn btn-sm btn-success" onclick="app.ui.openModal('basicAuthModal')">+ Add Basic Auth</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="basicAuthsTable">
                            <thead><tr><th>User</th><th>Desc</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Headers -->
                <div class="tab-pane fade" id="rp-headers">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>Headers</h4>
                        <button class="btn btn-sm btn-success" onclick="app.ui.openModal('headerModal')">+ Add Header</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="headersTable">
                            <thead><tr><th>Type</th><th>Header</th><th>Value</th><th>Desc</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- Layer 4 Tab -->
        <div class="tab-pane fade" id="layer4" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center">
                <h4>Layer 4 Routes</h4>
                <button class="btn btn-sm btn-success" onclick="app.ui.openModal('layer4Modal')">+ Add Route</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="layer4Table">
                    <thead><tr><th>En</th><th>Seq</th><th>Matcher</th><th>Listen Port</th><th>Upstream</th><th>Desc</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Certificates Tab -->
        <div class="tab-pane fade" id="certs" role="tabpanel">
            <h4>Custom Certificates</h4>
            <p>Upload your <code>.pem</code> and <code>.key</code> files here. They will be available for selection in Domains.</p>
            <div class="mb-3">
                <input class="form-control" type="file" id="certUploadInput">
                <button class="btn btn-primary mt-2" onclick="app.uploadCert()">Upload File</button>
            </div>
            <div id="certUploadStatus" class="status-box mb-3"></div>
            <h5>Available Files in ./certs/</h5>
            <ul id="certsList" class="list-group"></ul>
        </div>

        <!-- Control Tab -->
        <div class="tab-pane fade" id="control" role="tabpanel">
            <h4>Process Control</h4>
            <div class="mb-4">
                <button class="btn btn-success" onclick="app.control('start')">Start</button>
                <button class="btn btn-danger" onclick="app.control('stop')">Stop</button>
                <button class="btn btn-warning" onclick="app.control('reload')">Reload</button>
            </div>
            <div id="controlStatus" class="status-box mb-4"></div>

            <h4>Raw Caddyfile</h4>
            <textarea id="rawCaddyfile" readonly class="form-control bg-light mb-2"></textarea>

            <h4 class="mt-4">Stats</h4>
            <button class="btn btn-info btn-sm mb-2" onclick="app.fetchStats()">Refresh Stats</button>
            <pre id="statsOutput" class="status-box" style="display:block;"></pre>
        </div>

    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/app.js"></script>

<!-- Modals Container (Injected by JS) -->
<div id="modalsContainer"></div>

</body>
</html>
