## 2024-05-24 - CSRF in API endpoints without CORS
**Vulnerability:** A Cross-Site Request Forgery (CSRF) vulnerability was found in the application's state-changing `/api/` endpoints (e.g. `/api/start`, `/api/stop`, `/api/config/structured`, `/api/certs`). These endpoints accept POST and DELETE requests without checking the Origin, Referer, or requiring any anti-CSRF token.
**Learning:** Even though the frontend sends `application/json` or `multipart/form-data`, browsers can still submit simple HTML `<form>`s to these endpoints cross-origin without requiring CORS preflight. Since there's no authentication session, this means any cross-origin site can instruct the browser to reconfigure or control the Caddy server simply by sending POST requests. This highlights that APIs intended for local usage still need CSRF protection.
**Prevention:** Always implement CSRF protection on state-changing API endpoints, even if they don't use cookies for authentication. A robust defense is to require a custom header like `X-Requested-With: XMLHttpRequest` on all state-changing API requests. Because custom headers trigger CORS preflight checks, and the server doesn't respond with `Access-Control-Allow-Headers`, the browser will automatically block the CSRF attempt.
